{{define "content"}}
<div class="content-wrapper">
    <div class="content-header">
        <h1>User Management</h1>
        <div class="breadcrumb">
            <a href="/">Home</a> &rsaquo; 
            <a href="/admin">Admin Panel</a> &rsaquo; 
            User Management
        </div>
    </div>
    
    <div class="content-body">
        <div class="mb-20" class="actions-container">
            <span>Sort by:</span>
            <a href="/admin/users?sort=username&order={{if and (eq .sortBy "username") (eq .order "asc")}}desc{{else}}asc{{end}}" 
               class="btn btn-sm {{if eq .sortBy "username"}}btn-secondary{{end}}">
                Username {{if and (eq .sortBy "username") (eq .order "asc")}}â†‘{{else if and (eq .sortBy "username") (eq .order "desc")}}â†“{{end}}
            </a>
            <a href="/admin/users?sort=user_type&order={{if and (eq .sortBy "user_type") (eq .order "asc")}}desc{{else}}asc{{end}}" 
               class="btn btn-sm {{if eq .sortBy "user_type"}}btn-secondary{{end}}">
                Type {{if and (eq .sortBy "user_type") (eq .order "asc")}}â†‘{{else if and (eq .sortBy "user_type") (eq .order "desc")}}â†“{{end}}
            </a>
            <a href="/admin/users?sort=created_at&order={{if and (eq .sortBy "created_at") (eq .order "asc")}}desc{{else}}asc{{end}}" 
               class="btn btn-sm {{if eq .sortBy "created_at"}}btn-secondary{{end}}">
                Joined {{if and (eq .sortBy "created_at") (eq .order "asc")}}â†‘{{else if and (eq .sortBy "created_at") (eq .order "desc")}}â†“{{end}}
            </a>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Joined</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {{range .users}}
                <tr>
                    <td>
                        <a href="/profile/{{.Username}}" {{if .IsBanned}}class="user-banned"{{end}}>{{.Username}}</a>
                        <a href="mailto:{{.Email}}">ðŸ“§</a>
                    </td>
                    <td><span class="user-{{.UserType.String}}">{{.UserType.String | title}}</span></td>
                    <td>
                        {{if .IsBanned}}
                            <span class="user-banned">ðŸš« Banned</span>
                        {{else}}
                            <span class="user-active">âœ… Active</span>
                        {{end}}
                    </td>
                    <td>{{.CreatedAt.Format "2006-01-02"}}</td>
                    <td>
                        <div class="actions-container">
                            <a href="/admin/user/{{.ID}}/edit" class="btn btn-sm btn-secondary">Edit</a>
                            
                            {{if .IsBanned}}
                                <form method="post" action="/admin/user/{{.ID}}/unban" class="inline-form">
                                    <button type="submit" class="btn btn-sm btn-success">Unban</button>
                                </form>
                            {{else}}
                                <button onclick="showBanModal({{.ID}}, '{{.Username}}')" class="btn btn-sm btn-danger">Ban</button>
                            {{end}}
                            
                            {{if ne $.user.ID .ID}}
                                <button onclick="showUserTypeModal({{.ID}}, '{{.Username}}', '{{.UserType.String}}')" class="btn btn-sm">Change</button>
                            {{end}}
                        </div>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
        <!-- Pagination Controls -->
        <div class="pagination">
            {{if gt .totalPages 1}}
                {{if gt .page 1}}
                    <a href="/admin/users?sort={{.sortBy}}&order={{.order}}&page={{sub .page 1}}" class="btn btn-sm">Prev</a>
                {{else}}
                    <span class="btn btn-sm btn-disabled">Prev</span>
                {{end}}
                {{range $i := until .totalPages}}
                    {{ $pageNum := add $i 1 }}
                    {{if eq $.page $pageNum}}
                        <span class="btn btn-sm btn-secondary">{{$pageNum}}</span>
                    {{else}}
                        <a href="/admin/users?sort={{$.sortBy}}&order={{$.order}}&page={{$pageNum}}" class="btn btn-sm">{{$pageNum}}</a>
                    {{end}}
                {{end}}
                {{if lt .page .totalPages}}
                    <a href="/admin/users?sort={{.sortBy}}&order={{.order}}&page={{add .page 1}}" class="btn btn-sm">Next</a>
                {{else}}
                    <span class="btn btn-sm btn-disabled">Next</span>
                {{end}}
            {{end}}
        </div>
    </div>
</div>

<!-- Ban Modal -->
<div id="banModal">
    <div id="banModalContainer">
        <h3 class="mb-20">Ban User</h3>
        <form id="banForm" method="post">
            <div class="form-group">
                <label for="reason">Reason:</label>
                <textarea id="reason" name="reason" placeholder="Enter ban reason..." required></textarea>
            </div>
            <div class="form-group">
                <label for="duration">Duration:</label>
                <select id="duration" name="duration">
                    <option value="1">1 Day</option>
                    <option value="7">1 Week</option>
                    <option value="30">1 Month</option>
                    <option value="permanent">Permanent</option>
                </select>
            </div>
            <div class="actions-container">
                <button type="button" onclick="hideBanModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-danger">Ban User</button>
            </div>
        </form>
    </div>
</div>

<!-- User Type Modal -->
<div id="userTypeModal">
    <div id="userTypeModalContainer">
        <h3 class="mb-20">Change User Type</h3>
        <form id="userTypeForm" method="post">
            <div class="form-group">
                <label for="user_type">New Type:</label>
                <select id="user_type" name="user_type">
                    <option value="user">User</option>
                    <option value="moderator">Moderator</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="actions-container">
                <button type="button" onclick="hideUserTypeModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-success">Change</button>
            </div>
        </form>
    </div>
</div>

<script>
// Scripts are allowed here since this is an admin-only page
function showBanModal(userId, username) {
    document.getElementById('banForm').action = '/admin/user/' + userId + '/ban';
    document.getElementById('banModal').style.display = 'block';
}

function hideBanModal() {
    document.getElementById('banModal').style.display = 'none';
}

function showUserTypeModal(userId, username, currentType) {
    document.getElementById('userTypeForm').action = '/admin/user/' + userId + '/type';
    document.getElementById('userTypeModal').style.display = 'block';
}

function hideUserTypeModal() {
    document.getElementById('userTypeModal').style.display = 'none';
}

// Close modals when clicking outside
window.onclick = function(event) {
    if (event.target.id === 'banModal') hideBanModal();
    if (event.target.id === 'userTypeModal') hideUserTypeModal();
}
</script>
{{end}}
